Question about viruses:
From the five counties with the highest virus prevalence - how many bees were detected during the year?

WITH county AS (
  SELECT
    loc.county,
    SUM(obs.occurence) FILTER (WHERE org.type = 'Virus') AS virus_total,
    SUM(obs.occurence) FILTER (WHERE org.type = 'Bee')   AS bee_total
  FROM fact_observation obs
  JOIN dim_organism  org ON org.id = obs.organismkey
  JOIN dim_locations loc ON loc.id = obs.locationkey
  JOIN dim_date      dt ON dt.id = obs.datekey
  WHERE dt.year = *year in question*
  GROUP BY loc.county
)
SELECT
  county,
  virus_total AS virus_count,
  bee_total   AS bee_count
FROM county
ORDER BY virus_total DESC
LIMIT 5;


Question about mites:
How many bee occurrences are there in the counties with the fewest and the most Varroa mites?

WITH varroa_by_county AS (
  SELECT
    loc.county,
    AVG(obs.occurence) AS avg_varroa
  FROM fact_observation obs
  JOIN dim_organism  org ON org.id = obs.organismkey
  JOIN dim_locations loc ON loc.id = obs.locationkey
  WHERE org.type = 'Pest'
    AND org.name = 'Varroa'
  GROUP BY loc.county
),
minmax AS (
  SELECT *
  FROM varroa_by_county
  WHERE avg_varroa = (SELECT MIN(avg_varroa) FROM varroa_by_county)
     OR avg_varroa = (SELECT MAX(avg_varroa) FROM varroa_by_county)
)
SELECT
  m.county,
  m.avg_varroa AS average_varroa,
  SUM(obs.occurence) AS bee_occurrences
FROM minmax m
JOIN dim_locations loc ON loc.county = m.county
JOIN fact_observation obs ON obs.locationkey = loc.id
JOIN dim_organism org ON org.id = obs.organismkey
WHERE org.type = 'Bee'
GROUP BY m.county, m.avg_varroa
ORDER BY m.avg_varroa;


Question about fungus:
How many bee occurrences are there in the counties with the lowest and highest levels of Nosema fungus?

WITH nosema_by_county AS (
  SELECT
    loc.county,
    AVG(obs.occurence) AS avg_nosema
  FROM fact_observation obs
  JOIN dim_organism  org ON org.id = obs.organismkey
  JOIN dim_locations loc ON loc.id = obs.locationkey
  WHERE org.type = 'Pest'
    AND org.name = 'Nosema'
  GROUP BY loc.county
),
minmax AS (
  SELECT *
  FROM nosema_by_county
  WHERE avg_nosema = (SELECT MIN(avg_nosema) FROM nosema_by_county)
     OR avg_nosema = (SELECT MAX(avg_nosema) FROM nosema_by_county)
)
SELECT
  ext.county,
  ext.avg_nosema AS average_nosema,
  SUM(obs.occurence) AS bee_occurrences
FROM minmax m
JOIN dim_locations loc ON loc.county = m.county
JOIN fact_observation obs ON obs.locationkey = loc.id
JOIN dim_organism org ON org.id = obs.organismkey
WHERE org.type = 'Bee'
GROUP BY m.county, m.avg_nosema
ORDER BY m.avg_nosema;

Question about bees’ safety per county:
Which county is most popular for beekeeping and which is most safe from pests?

WITH bee_popularity AS (
  SELECT
    loc.county,
    SUM(obs.occurence) AS bee_count
  FROM fact_observation obs
  JOIN dim_organism  org ON org.id = obs.organismkey
  JOIN dim_locations loc ON loc.id = obs.locationkey
  WHERE org.type = 'Bee'
  GROUP BY loc.county
),

pest_levels AS (
  SELECT
    loc.county,
    AVG(CASE WHEN org.name = 'Varroa' THEN obs.occurence ELSE 0 END) AS avg_varroa,
    AVG(CASE WHEN org.name = 'Nosema' THEN obs.occurence ELSE 0 END) AS avg_nosema,
    SUM(CASE WHEN org.type = 'Virus' THEN obs.occurence ELSE 0 END)       AS virus_sum
  FROM fact_observation obs
  JOIN dim_organism  org ON org.id = obs.organismkey
  JOIN dim_locations loc ON loc.id = obs.locationkey
  WHERE org.type IN ('Pest', 'Virus')
  GROUP BY loc.county
)

SELECT
  bee.county,
  bee.bee_count,
  pest.avg_varroa,
  pest.avg_nosema,
  pest.virus_sum,
  (pest.avg_varroa + pest.avg_nosema + pest.virus_sum) AS pest_score
FROM bee_popularity bee
JOIN pest_levels pest USING (county)
ORDER BY bee.bee_count DESC, pest_score ASC;


Question about bees’ health per breed:
Which breed is the most common and therefore most resistant to pests?

SELECT
  org.breed,
  COUNT(obs.occurence) AS breed_count
FROM fact_observation obs
JOIN dim_organism org ON org.id = obs.organismkey
WHERE org.type = 'Bee'
GROUP BY org.breed
ORDER BY breed_count DESC;

